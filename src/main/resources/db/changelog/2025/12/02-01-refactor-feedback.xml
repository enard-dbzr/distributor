<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.33.xsd"
        objectQuotingStrategy="QUOTE_ONLY_RESERVED_WORDS">

    <changeSet id="1764659092897-create-sendings-table" author="enard">
        <createTable tableName="service_sendings">
            <column name="interaction_id" type="BIGINT">
                <constraints primaryKey="true" primaryKeyName="pk_service_sendings"/>
            </column>
            <column name="service_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="1764659092897-add-button-click-content" author="enard">
        <addColumn tableName="interaction_contents">
            <column name="source_interaction_id" type="BIGINT"/>
            <column name="tag" type="VARCHAR(255)"/>
        </addColumn>
    </changeSet>


    <changeSet id="1764659092897-copy-service-sendings" author="enard">
        <sql>
            INSERT INTO service_sendings (interaction_id, service_id)
            SELECT DISTINCT i.id, p.service_id
            FROM participants p
                     INNER JOIN interactions i
                                ON i.sender_id = p.id OR i.recipient_id = p.id
            WHERE p.type = 'SERVICE';
        </sql>

        <update tableName="participants">
            <column name="type" value="BOT"/>
            <where>type = 'SERVICE'</where>
        </update>
    </changeSet>

    <changeSet id="1764659092897-remove-service-participant" author="enard">
        <update tableName="participants">
            <column name="type" value="BOT"/>
            <where>type = 'SERVICE'</where>
        </update>

        <dropColumn columnName="service_id" tableName="participants"/>
    </changeSet>

    <changeSet id="1764659092897-drop-feedbacks" author="enard">
        <dropForeignKeyConstraint baseTableName="feedbacks" constraintName="fk_feedbacks_on_payload"/>

        <dropTable cascadeConstraints="true" tableName="feedback_payloads"/>
        <dropTable cascadeConstraints="true" tableName="feedbacks"/>
    </changeSet>

</databaseChangeLog>